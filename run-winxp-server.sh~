#!/bin/bash

# --- CONFIGURATION ---
VM_IMAGE="winxp-converted.qcow2"
RAM_SIZE="2048"
VNC_DISPLAY=":8"
# Shared folder path (Ensure this exists)
SHARED_PATH="/hc/sftp/vms/xp_projects"
# ---------------------

# 1. Check if Shared Folder exists
if [ ! -d "$SHARED_PATH" ]; then
    echo "Creating shared folder directory..."
    mkdir -p "$SHARED_PATH"
fi

echo "Starting Windows XP..."
echo " - VNC: Port 5908 (Password required)"
echo " - RDP: Localhost:3389 (Requires SSH Tunnel)"
echo " - Monitor: Type 'change vnc password' to set VNC access."

# 2. Launch QEMU
# -hostfwd=tcp:127.0.0.1:3389... -> Binds RDP only to localhost (Safe)
# -usb -device usb-tablet -> Fixes mouse cursor synchronization
qemu-system-i386 \
  -m $RAM_SIZE \
  -hda "$VM_IMAGE" \
  -device rtl8139,netdev=net0 \
  -netdev user,id=net0,hostfwd=tcp:127.0.0.1:3389-:3389 \
  -accel tcg \
  -usb -device usb-tablet \
  -vnc $VNC_DISPLAY,password=on \
  -monitor stdio
